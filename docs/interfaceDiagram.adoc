Excelente punto. Tienes toda la raz贸n. Mi error en la respuesta anterior fue omitir las im谩genes y simplificar demasiado; tu intuici贸n es 100% correcta.

Vamos a hacer esto bien, de forma minuciosa y expl铆cita, como lo requiere el Hito 4.

Respondiendo a tus preguntas primero:

"驴Deber铆a ir en un nuevo adoc?"

No. Esto es el refinamiento del Hito 3. El artefacto (interfaceDiagram.adoc o donde lo tengas incluido) evoluciona. Simplemente reemplazas el contenido del Hito 3 (que era la v1) por esta nueva versi贸n v2 (Hito 4). Es el mismo documento, pero madurado.

"驴Por qu茅 eliminaste la referencia a la imagen?"

Error m铆o. Fui negligente al centrarme solo en el texto del contrato. La imagen es fundamental porque, seg煤n Cheesman & Daniels, el contrato de interfaz (texto) est谩 vinculado al diagrama de interfaz (visual) y su modelo de informaci贸n (clases/DTOs). La imagen debe permanecer.

З Paso 1: Refinamiento de Contratos v2 (100% Completo)
Aqu铆 est谩 la correcci贸n minuciosa y expl铆cita de tu documento.

La diferencia clave entre el Hito 3 (v1) y el Hito 4 (v2) es:

v1 (Hito 3): Describe el "camino feliz" para validar que las interacciones son suficientes.

v2 (Hito 4): Especifica contractualmente el comportamiento completo, incluyendo firmas expl铆citas, cl谩usulas numeradas (PRE/POST) y, lo m谩s importante, las Post-condiciones de Error (POST-ERR).

Aqu铆 est谩 tu documento, actualizado al 100% para el Hito 4.

==== 5.4.2 Diagramas de especificaci贸n de interfaces (v2 Hito 4)

A continuaci贸n, se formaliza el contrato de especificaci贸n de cada interfaz provista por los componentes del sistema, siguiendo la metodolog铆a CBSE. Cada cl谩usula es normativa para la implementaci贸n y verificable.

===== 1. Componente: Consulta Disponibilidad

====== 1.1. Interface: IConsultaDisponibilidad

Esta interfaz, optimizada para ASR-RE-01 (Rendimiento), provee las operaciones para el CU-01.

image::img/interfaceDiagram/IConsultaDisponibilidad.jpg[Diagrama de Interfaz IConsultaDisponibilidad]

.Contrato de Operaci贸n: buscarDisponibilidad

Operaci贸n: buscarDisponibilidad(filtro: FiltroBusqueda): Lista<ResultadoDisponibilidad>

Pre-condiciones:

PRE-01: filtro no debe ser nulo.

PRE-02: filtro.fechaInicio debe ser cronol贸gicamente anterior a filtro.fechaFin.

PRE-03: filtro.fechaInicio debe ser igual o posterior a la fecha actual del sistema.

Post-condiciones (xito):

POST-01: Retorna una Lista<ResultadoDisponibilidad> que coincide con el filtro (la lista puede ser vac铆a si no hay coincidencias).

POST-02: La latencia de la operaci贸n debe cumplir con ASR-RE-01 (500 QPS).

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01, PRE-02 o PRE-03 fallan, se debe retornar una excepci贸n ArgumentoInvalidoException.

===== 2. Componente: GestionReservas

====== 2.1. Interface: IGestionReserva

Interfaz transaccional principal para crear (CU-02) y cancelar (CU-04) reservas, optimizada para ASR-CF-01 (Confiabilidad).

image::img/interfaceDiagram/IGestionReserva.jpg[Diagrama de Interfaz IGestionReserva]

.Contrato de Operaci贸n: crearReserva

Operaci贸n: crearReserva(idHuesped: string, idTipoHabitacion: string, fechas: RangoFechas, datosPago: DatosPago): Reservacion

Pre-condiciones:

PRE-01: El idHuesped debe corresponder a un usuario autenticado (requiere ISesionUsuario.validarToken).

PRE-02: Debe existir disponibilidad de inventario para idTipoHabitacion en fechas (requiere IInventario.verificarDisponibilidad).

PRE-03: Los datosPago deben ser v谩lidos y el monto calculado (requiere ITarifas).

Post-condiciones (xito):

POST-01: Se invoca IPagos.procesarPago y este retorna un Pago con estado "Aprobado".

POST-02: Se crea una entidad Reservacion en estado "Confirmada".

POST-03: Se descuenta el inventario para idTipoHabitacion en fechas (garantizando ASR-CF-01 - 0 dobles reservas).

POST-04: Se encola una notificaci贸n de confirmaci贸n (requiere INotificacion.enviarEmail).

POST-05: Se emite un evento de auditor铆a "RESERVA_EXITOSA" (ASR-AU-01, requiere IAuditoria.registrarEvento).

POST-06: La operaci贸n retorna la entidad Reservacion creada.

Post-condiciones (Fallo):

POST-ERR-01: Si IPagos.procesarPago retorna "Rechazado", la operaci贸n debe abortar. No se debe crear la Reservacion y no se debe descontar el inventario. Se emite auditor铆a "RESERVA_PAGO_FALLIDO". Se retorna PagoRechazadoException.

.Contrato de Operaci贸n: cancelarReserva

Operaci贸n: cancelarReserva(idReserva: string, idHuesped: string): boolean

Pre-condiciones:

PRE-01: idReserva debe existir y pertenecer a idHuesped (requiere ISesionUsuario).

PRE-02: El estado de la Reservacion debe ser "Confirmada".

PRE-03: La pol铆tica de cancelaci贸n debe permitir la anulaci贸n en la fecha actual (requiere IPoliticas de AdministracionCentral).

Post-condiciones (xito):

POST-01: El estado de la Reservacion se actualiza a "Cancelada".

POST-02: Se libera el inventario asociado (requiere IInventario.liberarInventario).

POST-03: Si PRE-03 determina que aplica reembolso, se invoca IReembolso.procesarReembolso.

POST-04: Se emite un evento de auditor铆a "RESERVA_CANCELADA".

POST-05: Retorna true.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-03 falla (pol铆tica no lo permite), la operaci贸n retorna false. El estado de la Reservacion NO debe cambiar.

====== 2.2. Interface: IConsultaCliente

Permite a un hu茅sped consultar sus propias reservas (CU-06).

image::img/interfaceDiagram/IConsultaCliente.jpg[Diagrama de Interfaz IConsultaCliente]

.Contrato de Operaci贸n: obtenerMisReservas

Operaci贸n: obtenerMisReservas(idHuesped: string): Lista<Reservacion>

Pre-condiciones:

PRE-01: idHuesped debe corresponder al usuario autenticado en la sesi贸n (requiere ISesionUsuario.validarToken).

Post-condiciones (xito):

POST-01: Retorna la lista (posiblemente vac铆a) de reservaciones (activas y pasadas) asociadas a ese Huesped.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01 falla, se retorna AccesoDenegadoException (ASR-SE-01).

====== 2.3. Interface: IBusquedaReserva

Permite al personal (Recepcionista) buscar reservas (CU-11).

image::img/interfaceDiagram/IBusquedaReserva.jpg[Diagrama de Interfaz IBusquedaReserva]

.Contrato de Operaci贸n: buscarReservaPorId

Operaci贸n: buscarReservaPorId(idReserva: string, idPersonal: string): Reservacion

Pre-condiciones:

PRE-01: El idPersonal (Recepcionista) debe estar autenticado y autorizado (requiere IAutorizacion).

Post-condiciones (xito):

POST-01: Retorna la Reservacion si se encuentra, o null si no existe.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01 falla, se retorna AccesoDenegadoException (ASR-SE-02).

.Contrato de Operaci贸n: buscarReservaPorHuesped

Operaci贸n: buscarReservaPorHuesped(email: string, idPersonal: string): Lista<Reservacion>

Pre-condiciones:

PRE-01: El idPersonal (Recepcionista) debe estar autenticado y autorizado (requiere IAutorizacion).

Post-condiciones (xito):

POST-01: Retorna una lista (posiblemente vac铆a) de Reservacion asociadas al email del Huesped.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01 falla, se retorna AccesoDenegadoException (ASR-SE-02).

===== 3. Componente: Pagos

====== 3.1. Interface: IPagos

Encapsula el procesamiento de cobros (CU-03, CU-08, CU-10), garantizando ASR-CF-02 (0 dobles cobros).

image::img/interfaceDiagram/IPagos.jpg[Diagrama de Interfaz IPagos]

.Contrato de Operaci贸n: procesarPago

Operaci贸n: procesarPago(monto: Dinero, idReferencia: string, datosPago: DatosPago): Pago

Pre-condiciones:

PRE-01: monto debe ser positivo.

PRE-02: idReferencia debe ser 煤nico (garant铆a de idempotencia para ASR-CF-02).

Post-condiciones (xito):

POST-01: Se conecta a IPasarelaExterna y esta aprueba la transacci贸n.

POST-02: Retorna un objeto Pago con estado "Aprobado" y un idTransaccionPasarela.

POST-03: Se emite un evento de auditor铆a "PAGO_APROBADO" (requiere IAuditoria).

Post-condiciones (Fallo):

POST-ERR-01: Si la IPasarelaExterna rechaza el pago, retorna Pago con estado "Rechazado". Se emite auditor铆a "PAGO_RECHAZADO".

POST-ERR-02: Si PRE-02 falla (intento de doble cobro), retorna el Pago original si existe, sin re-procesar.

POST-ERR-03: Si la conexi贸n con IPasarelaExterna falla (contingencia ASR-DA-02), retorna Pago con estado "Indeterminado" y se encola para revisi贸n.

====== 3.2. Interface: IReembolso

Procesa devoluciones de dinero (CU-04).

image::img/interfaceDiagram/IReembolso.jpg[Diagrama de Interfaz IReembolso]

.Contrato de Operaci贸n: procesarReembolso

Operaci贸n: procesarReembolso(idTransaccionOriginal: string, monto: Dinero): Reembolso

Pre-condiciones:

PRE-01: idTransaccionOriginal debe existir y corresponder a un Pago "Aprobado".

PRE-02: monto es positivo y menor o igual al monto original del Pago.

Post-condiciones (xito):

POST-01: Se conecta a IPasarelaExterna y esta aprueba la devoluci贸n.

POST-02: Retorna un objeto Reembolso con estado "Procesado".

POST-03: Se emite un evento de auditor铆a "REEMBOLSO_EXITOSO" (requiere IAuditoria).

Post-condiciones (Fallo):

POST-ERR-01: Si la pasarela rechaza la devoluci贸n, retorna Reembolso con estado "Fallido". Se emite auditor铆a "REEMBOLSO_FALLIDO".

===== 4. Componente: GestionEstancias

====== 4.1. Interface: IGestionCheckIn

Maneja el registro de entrada del hu茅sped (CU-07).

image::img/interfaceDiagram/IGestionCheckIn.jpg[Diagrama de Interfaz IGestionCheckIn]

.Contrato de Operaci贸n: realizarCheckIn

Operaci贸n: realizarCheckIn(idReserva: string, idRecepcionista: string): Estancia

Pre-condiciones:

PRE-01: idRecepcionista debe estar autenticado y autorizado (requiere IAutorizacion).

PRE-02: idReserva debe existir, estar en estado "Confirmada" (requiere IBusquedaReserva).

PRE-03: La fecha de inicio de la reserva debe ser la fecha actual del sistema.

Post-condiciones (xito):

POST-01: Se crea una entidad Estancia en estado "Activa", asociada a la Reservacion.

POST-02: El estado de la Habitacion asignada se actualiza a "Ocupada" (requiere IInventario.actualizarEstadoHabitacion).

POST-03: Se emite un evento de auditor铆a "CHECKIN_EXITOSO" (requiere IAuditoria).

POST-04: Retorna la Estancia creada.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-02 o PRE-03 fallan, retorna CheckInInvalidoException. No se debe crear la Estancia.

====== 4.2. Interface: IGestionCheckOut

Maneja el registro de salida del hu茅sped (CU-08).

image::img/interfaceDiagram/IGestionCheckOut.jpg[Diagrama de Interfaz IGestionCheckOut]

.Contrato de Operaci贸n: realizarCheckOut

Operaci贸n: realizarCheckOut(idEstancia: string, idRecepcionista: string): Factura

Pre-condiciones:

PRE-01: idRecepcionista debe estar autenticado y autorizado (requiere IAutorizacion).

PRE-02: idEstancia debe existir y estar en estado "Activa".

PRE-03: La cuenta de la estancia (todos los Consumos) debe estar saldada (requiere IPagos).

Post-condiciones (xito):

POST-01: El estado de la Estancia se actualiza a "Finalizada".

POST-02: El estado de la Habitacion asociada se actualiza a "Limpieza" (requiere IInventario).

POST-03: Se genera una Factura final.

POST-04: Se emite un evento de auditor铆a "CHECKOUT_EXITOSO".

POST-05: Retorna la Factura generada.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-03 falla (cuenta no saldada), retorna CuentaPendienteException. El estado de la Estancia NO debe cambiar.

====== 4.3. Interface: IGestionHabitacion

Maneja el cambio de habitaci贸n (CU-09) y la consulta de estados (CU-12).

image::img/interfaceDiagram/IGestionHabitacion.jpg[Diagrama de Interfaz IGestionHabitacion]

.Contrato de Operaci贸n: cambiarHabitacion

Operaci贸n: cambiarHabitacion(idEstancia: string, idHabitacionNueva: string, idRecepcionista: string): boolean

Pre-condiciones:

PRE-01: idRecepcionista debe estar autenticado y autorizado (requiere IAutorizacion).

PRE-02: idEstancia debe estar "Activa".

PRE-03: idHabitacionNueva debe ser v谩lida y estar "Disponible" (requiere IInventario.consultarEstado).

Post-condiciones (xito):

POST-01: La Estancia se desasocia de la habitaci贸n antigua y se asocia a idHabitacionNueva.

POST-02: El estado de la habitaci贸n antigua pasa a "Limpieza" (requiere IInventario).

POST-03: El estado de idHabitacionNueva pasa a "Ocupada" (requiere IInventario).

POST-04: Se emite un evento de auditor铆a "CAMBIO_HABITACION".

POST-05: Retorna true.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-03 falla, retorna HabitacionNoDisponibleException.

.Contrato de Operaci贸n: consultarEstadoHabitaciones

Operaci贸n: consultarEstadoHabitaciones(idHotel: string, idRecepcionista: string): Lista<EstadoHabitacion>

Pre-condiciones:

PRE-01: idRecepcionista debe estar autenticado y autorizado (requiere IAutorizacion).

PRE-02: idHotel debe ser v谩lido.

Post-condiciones (xito):

POST-01: Retorna la lista de estados de todas las habitaciones del hotel (optimizada para ASR-US-01).

====== 4.4. Interface: IConsumos

Registra cargos adicionales a la estancia (CU-10).

image::img/interfaceDiagram/IConsumos.jpg[Diagrama de Interfaz IConsumos]

.Contrato de Operaci贸n: registrarConsumo

Operaci贸n: registrarConsumo(idEstancia: string, monto: Dinero, descripcion: string): Consumo

Pre-condiciones:

PRE-01: idEstancia debe estar "Activa".

PRE-02: monto debe ser positivo.

Post-condiciones (xito):

POST-01: Se crea un nuevo Consumo asociado a la Estancia.

POST-02: Se emite un evento de auditor铆a "CONSUMO_REGISTRADO".

POST-03: Retorna el Consumo creado.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01 falla (estancia no activa), retorna EstanciaInactivaException.

===== 5. Componente: AdministracionCentral

(Interfaces: IInventario, ITarifas, IPoliticas, ICatalogoHotel, IGestionPersonal)

image::img/interfaceDiagram/IInventario.jpg[Diagrama de Interfaz IInventario] image::img/interfaceDiagram/ITarifas.jpg[Diagrama de Interfaz ITarifas] image::img/interfaceDiagram/IPoliticas.jpg[Diagrama de Interfaz IPoliticas] image::img/interfaceDiagram/ICatalogoHotel.jpg[Diagrama de Interfaz ICatalogoHotel] image::img/interfaceDiagram/IGestionPersonal.jpg[Diagrama de Interfaz IGestionPersonal]

.Contrato Gen茅rico para Operaciones CRUD (gestionar...)

Prop贸sito: Satisfacer CUs 13-33. Garantizar ASR-Consistencia de datos maestros.

Pre-condiciones:

PRE-01: El usuario debe estar autenticado y tener el rol "Administrador" (requiere IAutorizacion.verificarPermiso('ROL_ADMIN')).

PRE-02: Los datos de entrada (DTO) deben ser v谩lidos seg煤n las reglas de negocio (ej. monto positivo, fechas coherentes, ASR-Consistencia).

Post-condiciones (xito):

POST-01: La entidad (Hotel, Tarifa, Pol铆tica, etc.) es creada, actualizada o eliminada en la "fuente de verdad".

POST-02: Se emite un evento de auditor铆a "ADMIN_GESTION_EXITOSA" (requiere IAuditoria).

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01 falla, se debe retornar AccesoDenegadoException (ASR-SE-02).

POST-ERR-02: Si PRE-02 falla (datos inv谩lidos), se debe retornar ValidacionException.

===== 6. Componente: Autenticacion

====== 6.1. Interface: ISesionUsuario

Gestiona login, registro (CU-05, CU-25) y validaci贸n de tokens.

image::img/interfaceDiagram/ISesionUsuario.jpg[Diagrama de Interfaz ISesionUsuario]

.Contrato de Operaci贸n: login

Operaci贸n: login(credenciales: Credenciales): TokenSesion

Pre-condiciones:

PRE-01: Las credenciales no son nulas.

Post-condiciones (xito):

POST-01: Si las credenciales son v谩lidas (requiere IGestionPersonal o consulta de Hu茅sped), retorna un TokenSesion.

Post-condiciones (Fallo):

POST-ERR-01: Si son inv谩lidas, retorna LoginFallidoException y se emite un evento de auditor铆a "LOGIN_FALLIDO" (requiere IAuditoria).

.Contrato de Operaci贸n: registrarHuesped

Operaci贸n: registrarHuesped(datos: Huesped): Huesped (CU-05)

Pre-condiciones:

PRE-01: El email en datos no debe existir previamente en el sistema.

Post-condiciones (xito):

POST-01: Se crea un nuevo Huesped en el sistema.

POST-02: Se emite un evento de auditor铆a "HUESPED_REGISTRADO".

POST-03: Retorna el Huesped creado.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01 falla, retorna EmailDuplicadoException.

.Contrato de Operaci贸n: validarToken

Operaci贸n: validarToken(token: string): InfoUsuario

Pre-condiciones:

PRE-01: token no es nulo.

Post-condiciones (xito):

POST-01: Si el token es v谩lido y no ha expirado, retorna la InfoUsuario (ID, Rol) asociada.

Post-condiciones (Fallo):

POST-ERR-01: Si el token es inv谩lido o expirado, retorna TokenInvalidoException.

====== 6.2. Interface: IAutorizacion

Verifica roles y permisos (ASR-SE-01, ASR-SE-02).

image::img/interfaceDiagram/IAutorizacion.jpg[Diagrama de Interfaz IAutorizacion]

.Contrato de Operaci贸n: verificarPermiso

Operaci贸n: verificarPermiso(infoUsuario: InfoUsuario, permisoRequerido: string): boolean

Pre-condiciones:

PRE-01: infoUsuario es v谩lida (obtenida de ISesionUsuario.validarToken).

Post-condiciones:

POST-01: Retorna true si el rol en infoUsuario tiene el permisoRequerido.

POST-02: Retorna false si no tiene permiso.

POST-03: Si retorna false, se emite un evento de auditor铆a "ACCESO_DENEGADO_ROL" (ASR-SE-01, requiere IAuditoria).

===== 7. Componente: Notificaciones

====== 7.1. Interface: INotificacion

Abstracci贸n para env铆o as铆ncrono de comunicaciones (optimizado para no bloquear al cliente).

image::img/interfaceDiagram/INotificacion.jpg[Diagrama de Interfaz INotificacion]

.Contrato de Operaci贸n: enviarEmail / enviarSMS

Operaci贸n: enviarEmail(email: Email): boolean / enviarSMS(sms: SMS): boolean

Pre-condiciones:

PRE-01: Los datos del email o sms est谩n completos (destino, contenido).

Post-condiciones (xito):

POST-01: El mensaje se encola exitosamente para env铆o as铆ncrono (la operaci贸n no bloquea).

POST-02: La l贸gica de env铆o real se delega a IServicioEmailExterno o IServicioSmsExterno.

POST-03: Retorna true (significa "encolado", no "entregado").

Post-condiciones (Fallo):

POST-ERR-01: Si la cola de mensajer铆a est谩 ca铆da, retorna false (o lanza ColaCaidaException).

===== 8. Componente: Auditoria

====== 8.1. Interface: IAuditoria

Recibe eventos de log de alta prioridad (ASR-AU-01).

image::img/interfaceDiagram/IAuditoria.jpg[Diagrama de Interfaz IAuditoria]

.Contrato de Operaci贸n: registrarEvento

Operaci贸n: registrarEvento(evento: RegistroAuditoria): void

Pre-condiciones:

PRE-01: evento no es nulo y contiene la informaci贸n requerida (timestamp, actor, acci贸n, idTrazabilidad).

Post-condiciones (xito):

POST-01: El evento se almacena de forma persistente y segura en el "sumidero" de auditor铆a.

POST-02: La operaci贸n es "fire-and-forget" y no debe lanzar excepciones al componente que la llama (debe manejar sus propios fallos internamente).

====== 8.2. Interface: IConsultaTrazabilidad

Permite al actor Auditor rastrear transacciones (CU-34).

image::img/interfaceDiagram/IConsultaTrazabilidad.jpg[Diagrama de Interfaz IConsultaTrazabilidad]

.Contrato de Operaci贸n: rastrearTransaccion

Operaci贸n: rastrearTransaccion(idTrazabilidad: string, idAuditor: string): Lista<RegistroAuditoria>

Pre-condiciones:

PRE-01: El idAuditor debe estar autenticado y tener el rol "Auditor" (requiere IAutorizacion.verificarPermiso).

PRE-02: idTrazabilidad debe ser v谩lido.

Post-condiciones (xito):

POST-01: Retorna una lista ordenada cronol贸gicamente de todos los RegistroAuditoria que comparten el mismo idTrazabilidad.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01 falla, retorna AccesoDenegadoException (ASR-SE-02).