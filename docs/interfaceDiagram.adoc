==== Diagramas de especificación de interfaces (v2 Hito 4)

A continuación, se formaliza el contrato de especificación de cada interfaz provista por los componentes del sistema, siguiendo la metodología CBSE. Cada cláusula es normativa para la implementación y verificable.

===== Componente: Consulta Disponibilidad

====== Interface: IConsultaDisponibilidad

Esta interfaz, optimizada para ASR-RE-01 (Rendimiento), provee las operaciones para el CU-01.

image::img/interfaceDiagram/IConsultaDisponibilidad.jpg[Diagrama de Interfaz IConsultaDisponibilidad]

.Contrato de Operación: buscarDisponibilidad

Operación: buscarDisponibilidad(filtro: FiltroBusqueda): Lista<ResultadoDisponibilidad>

Pre-condiciones:

PRE-01: filtro no debe ser nulo.

PRE-02: filtro.fechaInicio debe ser cronológicamente anterior a filtro.fechaFin.

PRE-03: filtro.fechaInicio debe ser igual o posterior a la fecha actual del sistema.

Post-condiciones (Éxito):

POST-01: Retorna una Lista<ResultadoDisponibilidad> que coincide con el filtro (la lista puede ser vacía si no hay coincidencias).

POST-02: La latencia de la operación debe cumplir con ASR-RE-01 (500 QPS).

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01, PRE-02 o PRE-03 fallan, se debe retornar una excepción ArgumentoInvalidoException.

===== Componente: GestionReservas

====== Interface: IGestionReserva

Interfaz transaccional principal para crear (CU-02) y cancelar (CU-04) reservas, optimizada para ASR-CF-01 (Confiabilidad).

image::img/interfaceDiagram/IGestionReserva.jpg[Diagrama de Interfaz IGestionReserva]

.Contrato de Operación: crearReserva

Operación: crearReserva(idHuesped: string, idTipoHabitacion: string, fechas: RangoFechas, datosPago: DatosPago): Reservacion

Pre-condiciones:

PRE-01: El idHuesped debe corresponder a un usuario autenticado (requiere ISesionUsuario.validarToken).

PRE-02: Debe existir disponibilidad de inventario para idTipoHabitacion en fechas (requiere IInventario.verificarDisponibilidad).

PRE-03: Los datosPago deben ser válidos y el monto calculado (requiere ITarifas).

Post-condiciones (Éxito):

POST-01: Se invoca IPagos.procesarPago y este retorna un Pago con estado "Aprobado".

POST-02: Se crea una entidad Reservacion en estado "Confirmada".

POST-03: Se descuenta el inventario para idTipoHabitacion en fechas (garantizando ASR-CF-01 - 0 dobles reservas).

POST-04: Se encola una notificación de confirmación (requiere INotificacion.enviarEmail).

POST-05: Se emite un evento de auditoría "RESERVA_EXITOSA" (ASR-AU-01, requiere IAuditoria.registrarEvento).

POST-06: La operación retorna la entidad Reservacion creada.

Post-condiciones (Fallo):

POST-ERR-01: Si IPagos.procesarPago retorna "Rechazado", la operación debe abortar. No se debe crear la Reservacion y no se debe descontar el inventario. Se emite auditoría "RESERVA_PAGO_FALLIDO". Se retorna PagoRechazadoException.

.Contrato de Operación: cancelarReserva

Operación: cancelarReserva(idReserva: string, idHuesped: string): boolean

Pre-condiciones:

PRE-01: idReserva debe existir y pertenecer a idHuesped (requiere ISesionUsuario).

PRE-02: El estado de la Reservacion debe ser "Confirmada".

PRE-03: La política de cancelación debe permitir la anulación en la fecha actual (requiere IPoliticas de AdministracionCentral).

Post-condiciones (Éxito):

POST-01: El estado de la Reservacion se actualiza a "Cancelada".

POST-02: Se libera el inventario asociado (requiere IInventario.liberarInventario).

POST-03: Si PRE-03 determina que aplica reembolso, se invoca IReembolso.procesarReembolso.

POST-04: Se emite un evento de auditoría "RESERVA_CANCELADA".

POST-05: Retorna true.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-03 falla (política no lo permite), la operación retorna false. El estado de la Reservacion NO debe cambiar.

====== Interface: IConsultaCliente

Permite a un huésped consultar sus propias reservas (CU-06).

image::img/interfaceDiagram/IConsultaCliente.jpg[Diagrama de Interfaz IConsultaCliente]

.Contrato de Operación: obtenerMisReservas

Operación: obtenerMisReservas(idHuesped: string): Lista<Reservacion>

Pre-condiciones:

PRE-01: idHuesped debe corresponder al usuario autenticado en la sesión (requiere ISesionUsuario.validarToken).

Post-condiciones (Éxito):

POST-01: Retorna la lista (posiblemente vacía) de reservaciones (activas y pasadas) asociadas a ese Huesped.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01 falla, se retorna AccesoDenegadoException (ASR-SE-01).

====== Interface: IBusquedaReserva

Permite al personal (Recepcionista) buscar reservas (CU-11).

image::img/interfaceDiagram/IBusquedaReserva.jpg[Diagrama de Interfaz IBusquedaReserva]

.Contrato de Operación: buscarReservaPorId

Operación: buscarReservaPorId(idReserva: string, idPersonal: string): Reservacion

Pre-condiciones:

PRE-01: El idPersonal (Recepcionista) debe estar autenticado y autorizado (requiere IAutorizacion).

Post-condiciones (Éxito):

POST-01: Retorna la Reservacion si se encuentra, o null si no existe.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01 falla, se retorna AccesoDenegadoException (ASR-SE-02).

.Contrato de Operación: buscarReservaPorHuesped

Operación: buscarReservaPorHuesped(email: string, idPersonal: string): Lista<Reservacion>

Pre-condiciones:

PRE-01: El idPersonal (Recepcionista) debe estar autenticado y autorizado (requiere IAutorizacion).

Post-condiciones (Éxito):

POST-01: Retorna una lista (posiblemente vacía) de Reservacion asociadas al email del Huesped.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01 falla, se retorna AccesoDenegadoException (ASR-SE-02).

===== Componente: Pagos

====== Interface: IPagos

Encapsula el procesamiento de cobros (CU-03, CU-08, CU-10), garantizando ASR-CF-02 (0 dobles cobros).

image::img/interfaceDiagram/IPagos.jpg[Diagrama de Interfaz IPagos]

.Contrato de Operación: procesarPago

Operación: procesarPago(monto: Dinero, idReferencia: string, datosPago: DatosPago): Pago

Pre-condiciones:

PRE-01: monto debe ser positivo.

PRE-02: idReferencia debe ser único (garantía de idempotencia para ASR-CF-02).

Post-condiciones (Éxito):

POST-01: Se conecta a IPasarelaExterna y esta aprueba la transacción.

POST-02: Retorna un objeto Pago con estado "Aprobado" y un idTransaccionPasarela.

POST-03: Se emite un evento de auditoría "PAGO_APROBADO" (requiere IAuditoria).

Post-condiciones (Fallo):

POST-ERR-01: Si la IPasarelaExterna rechaza el pago, retorna Pago con estado "Rechazado". Se emite auditoría "PAGO_RECHAZADO".

POST-ERR-02: Si PRE-02 falla (intento de doble cobro), retorna el Pago original si existe, sin re-procesar.

POST-ERR-03: Si la conexión con IPasarelaExterna falla (contingencia ASR-DA-02), retorna Pago con estado "Indeterminado" y se encola para revisión.

====== Interface: IReembolso

Procesa devoluciones de dinero (CU-04).

image::img/interfaceDiagram/IReembolso.jpg[Diagrama de Interfaz IReembolso]

.Contrato de Operación: procesarReembolso

Operación: procesarReembolso(idTransaccionOriginal: string, monto: Dinero): Reembolso

Pre-condiciones:

PRE-01: idTransaccionOriginal debe existir y corresponder a un Pago "Aprobado".

PRE-02: monto es positivo y menor o igual al monto original del Pago.

Post-condiciones (Éxito):

POST-01: Se conecta a IPasarelaExterna y esta aprueba la devolución.

POST-02: Retorna un objeto Reembolso con estado "Procesado".

POST-03: Se emite un evento de auditoría "REEMBOLSO_EXITOSO" (requiere IAuditoria).

Post-condiciones (Fallo):

POST-ERR-01: Si la pasarela rechaza la devolución, retorna Reembolso con estado "Fallido". Se emite auditoría "REEMBOLSO_FALLIDO".

===== Componente: GestionEstancias

====== Interface: IGestionCheckIn

Maneja el registro de entrada del huésped (CU-07).

image::img/interfaceDiagram/IGestionCheckIn.jpg[Diagrama de Interfaz IGestionCheckIn]

.Contrato de Operación: realizarCheckIn

Operación: realizarCheckIn(idReserva: string, idRecepcionista: string): Estancia

Pre-condiciones:

PRE-01: idRecepcionista debe estar autenticado y autorizado (requiere IAutorizacion).

PRE-02: idReserva debe existir, estar en estado "Confirmada" (requiere IBusquedaReserva).

PRE-03: La fecha de inicio de la reserva debe ser la fecha actual del sistema.

Post-condiciones (Éxito):

POST-01: Se crea una entidad Estancia en estado "Activa", asociada a la Reservacion.

POST-02: El estado de la Habitacion asignada se actualiza a "Ocupada" (requiere IInventario.actualizarEstadoHabitacion).

POST-03: Se emite un evento de auditoría "CHECKIN_EXITOSO" (requiere IAuditoria).

POST-04: Retorna la Estancia creada.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-02 o PRE-03 fallan, retorna CheckInInvalidoException. No se debe crear la Estancia.

====== Interface: IGestionCheckOut

Maneja el registro de salida del huésped (CU-08).

image::img/interfaceDiagram/IGestionCheckOut.jpg[Diagrama de Interfaz IGestionCheckOut]

.Contrato de Operación: realizarCheckOut

Operación: realizarCheckOut(idEstancia: string, idRecepcionista: string): Factura

Pre-condiciones:

PRE-01: idRecepcionista debe estar autenticado y autorizado (requiere IAutorizacion).

PRE-02: idEstancia debe existir y estar en estado "Activa".

PRE-03: La cuenta de la estancia (todos los Consumos) debe estar saldada (requiere IPagos).

Post-condiciones (Éxito):

POST-01: El estado de la Estancia se actualiza a "Finalizada".

POST-02: El estado de la Habitacion asociada se actualiza a "Limpieza" (requiere IInventario).

POST-03: Se genera una Factura final.

POST-04: Se emite un evento de auditoría "CHECKOUT_EXITOSO".

POST-05: Retorna la Factura generada.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-03 falla (cuenta no saldada), retorna CuentaPendienteException. El estado de la Estancia NO debe cambiar.

====== Interface: IGestionHabitacion

Maneja el cambio de habitación (CU-09) y la consulta de estados (CU-12).

image::img/interfaceDiagram/IGestionHabitacion.jpg[Diagrama de Interfaz IGestionHabitacion]

.Contrato de Operación: cambiarHabitacion

Operación: cambiarHabitacion(idEstancia: string, idHabitacionNueva: string, idRecepcionista: string): boolean

Pre-condiciones:

PRE-01: idRecepcionista debe estar autenticado y autorizado (requiere IAutorizacion).

PRE-02: idEstancia debe estar "Activa".

PRE-03: idHabitacionNueva debe ser válida y estar "Disponible" (requiere IInventario.consultarEstado).

Post-condiciones (Éxito):

POST-01: La Estancia se desasocia de la habitación antigua y se asocia a idHabitacionNueva.

POST-02: El estado de la habitación antigua pasa a "Limpieza" (requiere IInventario).

POST-03: El estado de idHabitacionNueva pasa a "Ocupada" (requiere IInventario).

POST-04: Se emite un evento de auditoría "CAMBIO_HABITACION".

POST-05: Retorna true.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-03 falla, retorna HabitacionNoDisponibleException.

.Contrato de Operación: consultarEstadoHabitaciones

Operación: consultarEstadoHabitaciones(idHotel: string, idRecepcionista: string): Lista<EstadoHabitacion>

Pre-condiciones:

PRE-01: idRecepcionista debe estar autenticado y autorizado (requiere IAutorizacion).

PRE-02: idHotel debe ser válido.

Post-condiciones (Éxito):

POST-01: Retorna la lista de estados de todas las habitaciones del hotel (optimizada para ASR-US-01).

====== Interface: IConsumos

Registra cargos adicionales a la estancia (CU-10).

image::img/interfaceDiagram/IConsumos.jpg[Diagrama de Interfaz IConsumos]

.Contrato de Operación: registrarConsumo

Operación: registrarConsumo(idEstancia: string, monto: Dinero, descripcion: string): Consumo

Pre-condiciones:

PRE-01: idEstancia debe estar "Activa".

PRE-02: monto debe ser positivo.

Post-condiciones (Éxito):

POST-01: Se crea un nuevo Consumo asociado a la Estancia.

POST-02: Se emite un evento de auditoría "CONSUMO_REGISTRADO".

POST-03: Retorna el Consumo creado.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01 falla (estancia no activa), retorna EstanciaInactivaException.

===== Componente: AdministracionCentral

(Interfaces: IInventario, ITarifas, IPoliticas, ICatalogoHotel, IGestionPersonal)

image::img/interfaceDiagram/IInventario.jpg[Diagrama de Interfaz IInventario] image::img/interfaceDiagram/ITarifas.jpg[Diagrama de Interfaz ITarifas] image::img/interfaceDiagram/IPoliticas.jpg[Diagrama de Interfaz IPoliticas] image::img/interfaceDiagram/ICatalogoHotel.jpg[Diagrama de Interfaz ICatalogoHotel] image::img/interfaceDiagram/IGestionPersonal.jpg[Diagrama de Interfaz IGestionPersonal]

.Contrato Genérico para Operaciones CRUD (gestionar...)

Propósito: Satisfacer CUs 13-33. Garantizar ASR-Consistencia de datos maestros.

Pre-condiciones:

PRE-01: El usuario debe estar autenticado y tener el rol "Administrador" (requiere IAutorizacion.verificarPermiso('ROL_ADMIN')).

PRE-02: Los datos de entrada (DTO) deben ser válidos según las reglas de negocio (ej. monto positivo, fechas coherentes, ASR-Consistencia).

Post-condiciones (Éxito):

POST-01: La entidad (Hotel, Tarifa, Política, etc.) es creada, actualizada o eliminada en la "fuente de verdad".

POST-02: Se emite un evento de auditoría "ADMIN_GESTION_EXITOSA" (requiere IAuditoria).

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01 falla, se debe retornar AccesoDenegadoException (ASR-SE-02).

POST-ERR-02: Si PRE-02 falla (datos inválidos), se debe retornar ValidacionException.

===== Componente: Autenticacion

====== Interface: ISesionUsuario

Gestiona login, registro (CU-05, CU-25) y validación de tokens.

image::img/interfaceDiagram/ISesionUsuario.jpg[Diagrama de Interfaz ISesionUsuario]

.Contrato de Operación: login

Operación: login(credenciales: Credenciales): TokenSesion

Pre-condiciones:

PRE-01: Las credenciales no son nulas.

Post-condiciones (Éxito):

POST-01: Si las credenciales son válidas (requiere IGestionPersonal o consulta de Huésped), retorna un TokenSesion.

Post-condiciones (Fallo):

POST-ERR-01: Si son inválidas, retorna LoginFallidoException y se emite un evento de auditoría "LOGIN_FALLIDO" (requiere IAuditoria).

.Contrato de Operación: registrarHuesped

Operación: registrarHuesped(datos: Huesped): Huesped (CU-05)

Pre-condiciones:

PRE-01: El email en datos no debe existir previamente en el sistema.

Post-condiciones (Éxito):

POST-01: Se crea un nuevo Huesped en el sistema.

POST-02: Se emite un evento de auditoría "HUESPED_REGISTRADO".

POST-03: Retorna el Huesped creado.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01 falla, retorna EmailDuplicadoException.

.Contrato de Operación: validarToken

Operación: validarToken(token: string): InfoUsuario

Pre-condiciones:

PRE-01: token no es nulo.

Post-condiciones (Éxito):

POST-01: Si el token es válido y no ha expirado, retorna la InfoUsuario (ID, Rol) asociada.

Post-condiciones (Fallo):

POST-ERR-01: Si el token es inválido o expirado, retorna TokenInvalidoException.

====== Interface: IAutorizacion

Verifica roles y permisos (ASR-SE-01, ASR-SE-02).

image::img/interfaceDiagram/IAutorizacion.jpg[Diagrama de Interfaz IAutorizacion]

.Contrato de Operación: verificarPermiso

Operación: verificarPermiso(infoUsuario: InfoUsuario, permisoRequerido: string): boolean

Pre-condiciones:

PRE-01: infoUsuario es válida (obtenida de ISesionUsuario.validarToken).

Post-condiciones:

POST-01: Retorna true si el rol en infoUsuario tiene el permisoRequerido.

POST-02: Retorna false si no tiene permiso.

POST-03: Si retorna false, se emite un evento de auditoría "ACCESO_DENEGADO_ROL" (ASR-SE-01, requiere IAuditoria).

===== Componente: Notificaciones

====== Interface: INotificacion

Abstracción para envío asíncrono de comunicaciones (optimizado para no bloquear al cliente).

image::img/interfaceDiagram/INotificacion.jpg[Diagrama de Interfaz INotificacion]

.Contrato de Operación: enviarEmail / enviarSMS

Operación: enviarEmail(email: Email): boolean / enviarSMS(sms: SMS): boolean

Pre-condiciones:

PRE-01: Los datos del email o sms están completos (destino, contenido).

Post-condiciones (Éxito):

POST-01: El mensaje se encola exitosamente para envío asíncrono (la operación no bloquea).

POST-02: La lógica de envío real se delega a IServicioEmailExterno o IServicioSmsExterno.

POST-03: Retorna true (significa "encolado", no "entregado").

Post-condiciones (Fallo):

POST-ERR-01: Si la cola de mensajería está caída, retorna false (o lanza ColaCaidaException).

===== Componente: Auditoria

====== Interface: IAuditoria

Recibe eventos de log de alta prioridad (ASR-AU-01).

image::img/interfaceDiagram/IAuditoria.jpg[Diagrama de Interfaz IAuditoria]

.Contrato de Operación: registrarEvento

Operación: registrarEvento(evento: RegistroAuditoria): void

Pre-condiciones:

PRE-01: evento no es nulo y contiene la información requerida (timestamp, actor, acción, idTrazabilidad).

Post-condiciones (Éxito):

POST-01: El evento se almacena de forma persistente y segura en el "sumidero" de auditoría.

POST-02: La operación es "fire-and-forget" y no debe lanzar excepciones al componente que la llama (debe manejar sus propios fallos internamente).

====== Interface: IConsultaTrazabilidad

Permite al actor Auditor rastrear transacciones (CU-34).

image::img/interfaceDiagram/IConsultaTrazabilidad.jpg[Diagrama de Interfaz IConsultaTrazabilidad]

.Contrato de Operación: rastrearTransaccion

Operación: rastrearTransaccion(idTrazabilidad: string, idAuditor: string): Lista<RegistroAuditoria>

Pre-condiciones:

PRE-01: El idAuditor debe estar autenticado y tener el rol "Auditor" (requiere IAutorizacion.verificarPermiso).

PRE-02: idTrazabilidad debe ser válido.

Post-condiciones (Éxito):

POST-01: Retorna una lista ordenada cronológicamente de todos los RegistroAuditoria que comparten el mismo idTrazabilidad.

Post-condiciones (Fallo):

POST-ERR-01: Si PRE-01 falla, retorna AccesoDenegadoException (ASR-SE-02).
